name: ğŸ©º ç›‘æ§éš§é“å¥åº· (Health Check)

on:
  schedule:
    # æ¯ 15 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡éš§é“
    - cron: '*/15 * * * *'
  # ä¹Ÿå…è®¸ä½ æ‰‹åŠ¨åœ¨ Actions é¡µé¢ç‚¹å‡» "Run workflow" æ¥æµ‹è¯•
  workflow_dispatch:

jobs:
  check-health:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€æŸ¥éš§é“æ˜¯å¦é€š (Check Tunnel URL)
        id: check_status # <--- æ­¥éª¤ ID
        run: |
          # æˆ‘ä»¬ä¸å†ä½¿ç”¨ --fail
          # -s: é™éŸ³æ¨¡å¼
          # -o /dev/null: ä¸¢å¼ƒé¡µé¢å†…å®¹
          # -w "%{http_code}": åªè¾“å‡º HTTP çŠ¶æ€ç 
          # --max-time 10: 10 ç§’è¶…æ—¶
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://modal.kfc.pp.ua)
          
          echo "HTTP Status Code: $HTTP_STATUS"
          
          # å°†çŠ¶æ€ç ä¿å­˜ä¸º GitHub Step çš„è¾“å‡º
          echo "http_status=$HTTP_STATUS" >> $GITHUB_OUTPUT

      - name: ğŸ”´ éš§é“ä¸é€š! è§¦å‘é‡éƒ¨ç½² (Tunnel is down! Trigger redeploy)
        # å…³é”®é€»è¾‘ï¼šå½“çŠ¶æ€ç ä¸æ˜¯ 2xx å¹¶ä¸”ä¹Ÿä¸æ˜¯ 400 æ—¶
        if: |
          !startsWith(steps.check_status.outputs.http_status, '2') &&
          steps.check_status.outputs.http_status != '400'
        env:
          GITHUB_TOKEN: ${{ secrets.ACTION_TRIGGER_TOKEN }}
          REPO_NAME: ${{ github.repository }} 
          DEPLOY_WORKFLOW_FILE: 'main.yml' # ä¿æŒ 'main.yml'
        run: |
          echo "éš§é“è®¿é—®å¤±è´¥ (Status: ${{ steps.check_status.outputs.http_status }})ã€‚æ­£åœ¨è§¦å‘ 'Deploy to Modal' å·¥ä½œæµ..."
          
          curl --fail -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO_NAME/actions/workflows/$DEPLOY_WORKFLOW_FILE/dispatches" \
            -d '{"ref":"${{ github.ref_name }}"}'

      - name: âœ… éš§é“æ­£å¸¸ (Tunnel is healthy)
        # å…³é”®é€»è¾‘ï¼šå½“çŠ¶æ€ç æ˜¯ 2xx æˆ–è€…æ˜¯ 400 æ—¶
        if: |
          startsWith(steps.check_status.outputs.http_status, '2') ||
          steps.check_status.outputs.http_status == '400'
        run: |
          echo "éš§é“è®¿é—®æ­£å¸¸ (Status: ${{ steps.check_status.outputs.http_status }})ï¼Œæ— éœ€æ“ä½œã€‚"
